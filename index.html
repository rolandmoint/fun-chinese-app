<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Intelligence Education Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #FF9F43; --bg: #fffbeb; }
        body { font-family: 'Inter', system-ui, sans-serif; background-color: var(--bg); color: #1e293b; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #auth-portal { position: fixed; inset: 0; z-index: 100; backdrop-filter: blur(25px); background: rgba(255, 251, 235, 0.85); display: flex; align-items: center; justify-content: center; }
        .sidebar { background: #ffffff; border-right: 4px solid #fbbf24; }
        .flashcard { background: #ffffff; border-radius: 44px; box-shadow: 0 20px 60px rgba(251, 191, 36, 0.12); border: 2px solid #ffffff; }
        .chinese-char { font-size: clamp(80px, 15vw, 140px); line-height: 1; font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; cursor: pointer; color: #3b82f6; transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .chinese-char:active { transform: scale(0.85); }
        .star-btn { font-size: 34px; transition: transform 0.2s; cursor: pointer; filter: grayscale(1); opacity: 0.2; }
        .star-active { filter: grayscale(0) !important; opacity: 1 !important; color: #fbbf24 !important; drop-shadow: 0 0 12px #fbbf24; }
        .category-active { background: #fbbf24 !important; color: #ffffff !important; border-color: #d97706 !important; font-weight: 900; transform: translateX(5px); }
        .search-input { background: #f8fafc; border: 2px solid #f1f5f9; transition: all 0.3s; }
        .search-input:focus { border-color: #fbbf24; background: white; box-shadow: 0 4px 12px rgba(251, 191, 36, 0.1); }
        @media (max-width: 1024px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            .sidebar { width: 100%; border-right: none; height: auto; border-bottom: 4px solid #fbbf24; }
            .ai-sidebar { height: 500px; border-top: 4px solid #fbbf24; border-left: none; }
        }
    </style>
</head>
<body class="hidden">

    <!-- üîê CORE ACCESS PORTAL -->
    <div id="auth-portal">
        <div class="bg-white p-10 rounded-[48px] shadow-2xl w-full max-w-sm text-center border-4 border-amber-100">
            <h1 class="text-3xl font-black italic text-orange-500 mb-2 uppercase tracking-tighter">INTELLIGENCE CORE</h1>
            <p class="text-slate-400 text-[10px] font-bold tracking-[0.2em] mb-8 uppercase">Authorization Required</p>
            <div class="space-y-4">
                <input type="text" id="auth-user" placeholder="User ID" class="w-full bg-slate-50 border-2 border-slate-100 p-4 rounded-2xl outline-none focus:border-amber-400 font-bold uppercase text-xs tracking-widest">
                <input type="password" id="auth-pass" placeholder="Secure Password" class="w-full bg-slate-50 border-2 border-slate-100 p-4 rounded-2xl outline-none focus:border-amber-400 font-bold">
                <button onclick="handleLogin()" id="login-btn" class="w-full bg-orange-500 text-white font-black py-4 rounded-2xl shadow-lg uppercase tracking-widest hover:bg-orange-400 transition-all">Unlock System</button>
            </div>
            <p id="auth-error" class="mt-4 text-red-400 text-[10px] font-bold uppercase"></p>
        </div>
    </div>

    <!-- üå≤ NAVIGATION & FILTERS -->
    <aside class="sidebar w-80 p-6 flex flex-col gap-6 shrink-0">
        <header>
            <h1 id="user-display" class="text-2xl font-black italic text-orange-500 uppercase leading-none truncate">STUDENT</h1>
            <p class="text-amber-400 text-[8px] font-bold tracking-widest uppercase mt-1 italic">Personalized Data Feed</p>
        </header>

        <!-- üîç NEW: REAL-TIME SEARCH -->
        <div class="relative">
            <input type="text" id="word-search" oninput="handleSearch()" placeholder="Search word, pinyin..." class="search-input w-full p-3 rounded-xl text-xs font-bold outline-none pl-10">
            <span class="absolute left-3 top-3.5 opacity-30 text-xs">üîç</span>
        </div>

        <div>
            <div class="bg-amber-100 h-2.5 w-full rounded-full overflow-hidden mb-2">
                <div id="progress-bar" class="bg-amber-500 h-full w-0 transition-all duration-1000 ease-out"></div>
            </div>
            <div class="flex justify-between text-[10px] font-black text-amber-700 uppercase">
                <span id="progress-text">0 / 100</span><span id="progress-percent">0%</span>
            </div>
        </div>

        <nav class="space-y-2 overflow-y-auto pr-2 max-h-[40vh] scrollbar-none">
            <button id="btn-All" onclick="changeCategory('All')" class="nav-btn w-full text-left p-3 rounded-2xl bg-white border border-amber-50 text-slate-400 text-[10px] font-black uppercase transition-all">üåà Universal</button>
            <button id="btn-Nature" onclick="changeCategory('Nature')" class="nav-btn w-full text-left p-3 rounded-2xl bg-white border border-amber-50 text-slate-400 text-[10px] font-black uppercase transition-all">üåø Nature</button>
            <button id="btn-Health" onclick="changeCategory('Health')" class="nav-btn w-full text-left p-3 rounded-2xl bg-white border border-amber-50 text-slate-400 text-[10px] font-black uppercase transition-all">ü¶∏ Health</button>
            <button id="btn-Food" onclick="changeCategory('Food')" class="nav-btn w-full text-left p-3 rounded-2xl bg-white border border-amber-50 text-slate-400 text-[10px] font-black uppercase transition-all">ü•™ Food</button>
            <button id="btn-Animals" onclick="changeCategory('Animals')" class="nav-btn w-full text-left p-3 rounded-2xl bg-white border border-amber-50 text-slate-400 text-[10px] font-black uppercase transition-all">ü¶Å Animals</button>
            <button id="btn-Actions" onclick="changeCategory('Actions')" class="nav-btn w-full text-left p-3 rounded-2xl bg-white border border-amber-50 text-slate-400 text-[10px] font-black uppercase transition-all">‚ö° Actions</button>
            <button id="btn-Feelings" onclick="changeCategory('Feelings')" class="nav-btn w-full text-left p-3 rounded-2xl bg-white border border-amber-50 text-slate-400 text-[10px] font-black uppercase transition-all">üòä Feelings</button>
        </nav>
    </aside>

    <!-- üÉè FLASHCARD INTERFACE -->
    <main class="main-content flex-grow flex flex-col items-center justify-center p-6 relative">
        <div id="flashcard" class="w-full max-w-lg p-8 lg:p-14 text-center relative flashcard text-slate-900 border-4 border-white shadow-xl">
            <div onclick="toggleStar()" id="star-btn" class="absolute top-8 right-8 star-btn hover:scale-125 active:scale-95">‚≠ê</div>
            <div id="pinyin" class="text-amber-400 text-3xl font-black mb-3 tracking-widest uppercase italic">...</div>
            <div id="char" class="chinese-char font-black mb-6 drop-shadow-2xl" onclick="runSpeech('hk', 'word')"></div>
            <div id="radical" class="inline-block px-4 py-1.5 bg-blue-50 rounded-full text-[10px] font-black text-blue-400 mb-10 border border-blue-100 uppercase tracking-widest leading-none"></div>
            <div id="meaning" class="text-4xl font-black uppercase text-slate-800 mb-12 tracking-tighter italic decoration-amber-400 underline underline-offset-8"></div>
            
            <div class="border-t-2 border-amber-50/50 pt-10 text-left space-y-6">
                <div class="group flex justify-between items-start">
                    <p id="example" class="text-2xl font-bold text-slate-600 leading-tight group-hover:text-slate-900 transition-colors"></p>
                    <button onclick="handleUISpeaker(this, 'example_hk')" class="bg-amber-400 text-white w-8 h-8 rounded-full flex items-center justify-center shadow-md hover:bg-amber-500 shrink-0">üîä</button>
                </div>
                <div class="flex justify-between items-start border-l-4 border-amber-100 pl-4">
                    <p id="example-trans" class="text-sm font-medium text-slate-400 italic pr-4"></p>
                    <button onclick="handleUISpeaker(this, 'example_en')" class="bg-blue-400 text-white w-6 h-6 rounded-full flex items-center justify-center text-[8px] shadow-sm hover:bg-blue-500 shrink-0">üîä</button>
                </div>
            </div>
        </div>

        <div class="w-full max-w-lg mt-10 grid grid-cols-2 gap-4">
            <button onclick="runSpeech('hk', 'word')" class="audio-btn-main py-5 bg-orange-500 text-white rounded-[28px] font-black text-xs border-b-4 border-orange-700 uppercase tracking-widest hover:bg-orange-400">üîä CANTO</button>
            <button onclick="runSpeech('cn', 'word')" class="audio-btn-main py-5 bg-sky-500 text-white rounded-[28px] font-black text-xs border-b-4 border-sky-700 uppercase tracking-widest hover:bg-sky-400">üîä MANDO</button>
            <button onclick="nextCard()" class="col-span-2 py-6 bg-white text-slate-900 rounded-[32px] font-black text-2xl border-b-8 border-slate-200 active:border-0 active:translate-y-2 transition-all shadow-lg hover:bg-slate-50 uppercase tracking-tighter">Skip to Next &rarr;</button>
        </div>
    </main>

    <!-- ü§ñ AI SIDEBAR -->
    <aside class="ai-sidebar w-full lg:w-96 p-6 sidebar flex flex-col shrink-0 overflow-hidden shadow-inner">
        <header class="mb-6"><h3 class="font-black text-slate-700 uppercase tracking-tighter italic border-b-2 border-amber-100 pb-2 flex justify-between items-center">Coach_Bot <span class="text-[8px] opacity-30">V4.0_STABLE</span></h3></header>
        <div id="chat-history" class="flex-grow overflow-y-auto mb-4 space-y-4 bg-amber-50/20 rounded-3xl p-4 scrollbar-none border border-amber-50 font-medium"></div>
        <div class="flex gap-2">
            <input type="text" id="user-input" placeholder="Query data..." class="flex-grow bg-white border-2 border-amber-100 p-4 rounded-2xl text-sm focus:border-amber-400 outline-none" onkeypress="if(event.key==='Enter')sendMessage()">
            <button onclick="sendMessage()" class="bg-orange-500 text-white font-black px-6 rounded-2xl shadow-lg hover:bg-orange-400 active:scale-95 transition-all">GO</button>
        </div>
    </aside>

    <script>
        let allWords = [], sessionWords = [], learned = [], idx = 0, currentWord = null, currentUser = "";
        const synth = window.speechSynthesis;
        let activeSpeakerBtn = null;

        if (sessionStorage.getItem('auth_token')) { 
            currentUser = sessionStorage.getItem('username') || "guest";
            unlockUI(); 
        } else { document.body.classList.remove('hidden'); }

        async function handleLogin() {
            const user = document.getElementById('auth-user').value.toLowerCase();
            const pass = document.getElementById('auth-pass').value;
            const btn = document.getElementById('login-btn'); btn.innerText = "AUTHENTICATING...";
            try {
                const res = await fetch('/api/auth', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: user, password: pass }) });
                const data = await res.json();
                if (data.success) { 
                    sessionStorage.setItem('auth_token', data.token);
                    sessionStorage.setItem('username', user);
                    currentUser = user;
                    unlockUI();
                } else { document.getElementById('auth-error').innerText = "DENIED: " + data.error; btn.innerText = "Verify"; }
            } catch (e) { document.getElementById('auth-error').innerText = "FAILURE"; btn.innerText = "Verify"; }
        }

        function unlockUI() { document.getElementById('auth-portal').style.display = 'none'; document.body.classList.remove('hidden'); document.getElementById('user-display').innerText = currentUser; learned = JSON.parse(localStorage.getItem('learned_' + currentUser) || '[]'); init(); }

        async function init() {
            try {
                const r = await fetch('vocabulary.json?v='+Date.now()); allWords = await r.json();
                changeCategory('All'); updateProgress();
            } catch(e) { console.error(e); }
        }

        // üîç NEW: SEARCH LOGIC
        function handleSearch() {
            const val = document.getElementById('word-search').value.toLowerCase();
            sessionWords = allWords.filter(w => 
                w.char.toLowerCase().includes(val) || 
                w.pinyin.toLowerCase().includes(val) || 
                w.meaning.toLowerCase().includes(val)
            );
            if(sessionWords.length) { idx = 0; updateCard(); }
        }

        function changeCategory(cat) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.toggle('category-active', b.id === 'btn-'+cat));
            sessionWords = (cat === 'All') ? [...allWords] : allWords.filter(w => w.category === cat);
            if(sessionWords.length) { idx = Math.floor(Math.random() * sessionWords.length); updateCard(); }
        }

        function updateCard() {
            if(!sessionWords.length) return;
            currentWord = sessionWords[idx];
            document.getElementById('char').innerText = currentWord.char;
            document.getElementById('pinyin').innerText = currentWord.pinyin;
            document.getElementById('radical').innerText = `RADIX: ${currentWord.radical}`;
            document.getElementById('meaning').innerText = currentWord.meaning;
            document.getElementById('example').innerText = currentWord.example;
            document.getElementById('example-trans').innerText = currentWord.exampleTrans;
            document.getElementById('star-btn').classList.toggle('star-active', learned.includes(currentWord.char));
        }

        function toggleStar() {
            const c = currentWord.char;
            learned = learned.includes(c) ? learned.filter(x => x !== c) : [...learned, c];
            localStorage.setItem('learned_' + currentUser, JSON.stringify(learned));
            document.getElementById('star-btn').classList.toggle('star-active', learned.includes(c));
            updateProgress();
        }

        function updateProgress() {
            const pct = Math.round((learned.length / allWords.length) * 100);
            document.getElementById('progress-bar').style.width = pct + '%';
            document.getElementById('progress-text').innerText = learned.length + ' / 100 Mastery';
            document.getElementById('progress-percent').innerText = pct + '%';
        }

        function nextCard() { idx = (idx + 1) % sessionWords.length; updateCard(); }

        function coreSpeak(text, lang, btn) {
            if (activeSpeakerBtn === btn) { synth.cancel(); resetBtn(); return; }
            synth.cancel(); if (activeSpeakerBtn) resetBtn();
            const u = new SpeechSynthesisUtterance(text.replace(/[\u{1F300}-\u{1F9FF}]/gu, ''));
            const vw = synth.getVoices();
            if (lang === 'hk') { u.lang = 'zh-HK'; u.voice = vw.find(v => v.name.includes('Sin-Ji')) || vw.find(v => v.lang.includes('HK')); } 
            else if (lang === 'cn') { u.lang = 'zh-CN'; u.voice = vw.find(v => v.name.includes('Ting-Ting')) || vw.find(v => (v.lang.includes('CN') || v.lang.includes('Hans')) && !v.name.includes('HK')); } 
            else { u.lang = 'en-US'; u.voice = vw.find(v => v.lang.includes('en-US')); }
            u.rate = 0.8; 
            const isSpeakerBtn = btn.tagName === 'BUTTON';
            u.onstart = () => { if(isSpeakerBtn) { btn.innerText = "‚èπÔ∏è"; activeSpeakerBtn = btn; } };
            u.onend = resetBtn; u.onerror = resetBtn; synth.speak(u);
        }

        function resetBtn() { if (activeSpeakerBtn) activeSpeakerBtn.innerText = "üîä"; activeSpeakerBtn = null; }

        function handleUISpeaker(btn, type) {
            let text = ""; let lang = "hk";
            if(type === 'word_hk') { text = currentWord.char; lang = "hk"; }
            else if(type === 'word_cn') { text = currentWord.char; lang = "cn"; }
            else if(type === 'example_hk') { text = currentWord.example; lang = "hk"; }
            else if(type === 'example_en') { text = currentWord.exampleTrans; lang = "en"; }
            coreSpeak(text, lang, btn);
        }

        function handleAISpeaker(btn, segmentId) {
            const text = document.getElementById(segmentId).innerText;
            const isChi = /[\u4e00-\u9fa5]/.test(text.substring(0, 30));
            coreSpeak(text, isChi ? 'hk' : 'en', btn);
        }

        async function sendMessage() {
            const inp = document.getElementById('user-input'); const txt = inp.value.trim();
            if (!txt || !currentWord) return;
            const hist = document.getElementById('chat-history');
            hist.innerHTML += `<div class="bg-blue-100 p-4 rounded-3xl text-blue-600 text-[10px] ml-auto mb-4 text-right max-w-[85%] font-black uppercase shadow-sm">Query: ${txt}</div>`;
            inp.value = ''; const tid = 't-' + Date.now();
            hist.innerHTML += `<div id="${tid}" class="ai-chat-msg italic text-slate-400">Processing...</div>`;
            hist.scrollTop = hist.scrollHeight;
            try {
                const r = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: txt, word: currentWord.char }) });
                const d = await r.json();
                if (d.reply) {
                    document.getElementById(tid).innerHTML = d.reply.split('[BREAK]').map(s => {
                        const sId = 's-' + Math.random().toString(36).substring(7);
                        return `<div class="mb-3 relative pr-8 text-slate-600 leading-relaxed border-b border-amber-50 pb-2"><span id="${sId}">${s.trim()}</span><button onclick="handleAISpeaker(this, '${sId}')" class="speaker-sm absolute top-0 right-0 shadow-sm border-none">üîä</button></div>`;
                    }).join('');
                    document.getElementById(tid).classList.remove('italic');
                }
            } catch (e) { document.getElementById(tid).innerText = "NETWORK_ERROR"; }
            hist.scrollTop = hist.scrollHeight;
        }
        synth.onvoiceschanged = () => { synth.getVoices(); };
    </script>
</body>
</html>
