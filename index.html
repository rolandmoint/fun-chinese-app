<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Language Learning Hub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #f59e0b; --bg: #0f172a; --card: #ffffff; }
        body { font-family: 'Inter', system-ui, sans-serif; background-color: var(--bg); color: #f1f5f9; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        .sidebar { background: #1e293b; border-right: 1px solid #334155; }
        .flashcard { background: var(--card); border-radius: 32px; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .chinese-char { font-size: clamp(80px, 15vw, 140px); line-height: 1; font-family: "Microsoft JhengHei", sans-serif; cursor: pointer; }
        .audio-btn-main { transition: all 0.2s; box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        .audio-btn-main:active { transform: translateY(4px); box-shadow: none; }
        .star-btn { font-size: 28px; transition: transform 0.2s; }
        .star-active { color: #fbbf24 !important; filter: drop-shadow(0 0 8px #fbbf24); }
        .ai-chat-msg { background: #1e293b; border: 1px solid #334155; border-radius: 16px; padding: 12px; margin-bottom: 15px; position: relative; }
        .speaker-sm { background: #334155; border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; font-size: 10px; }
        
        @media (max-width: 1024px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            .sidebar { width: 100%; border-right: none; border-bottom: 1px solid #334155; }
            .main-content { min-height: 100vh; }
            .ai-sidebar { height: 500px; border-left: none; border-top: 1px solid #334155; }
        }
    </style>
</head>
<body>

    <!-- Sidebar -->
    <aside class="sidebar w-80 p-6 flex flex-col gap-8 shrink-0">
        <div>
            <h1 class="text-2xl font-black italic tracking-tighter text-amber-500 uppercase">Learning Core</h1>
            <p class="text-slate-500 text-[10px] font-mono tracking-widest uppercase">G3 Module | Secured</p>
        </div>

        <div>
            <label class="text-[10px] font-bold text-slate-500 uppercase mb-4 block">Mastery Progress</label>
            <div class="bg-slate-800 h-2 w-full rounded-full overflow-hidden mb-2">
                <div id="progress-bar" class="bg-amber-500 h-full w-0 transition-all duration-500"></div>
            </div>
            <div class="flex justify-between text-[10px] font-mono text-slate-400">
                <span id="progress-text">0 / 50 Learned</span>
                <span id="progress-percent">0%</span>
            </div>
        </div>

        <nav class="space-y-2 overflow-y-auto pr-2">
            <label class="text-[10px] font-bold text-slate-500 uppercase mb-2 block">Modules</label>
            <button onclick="changeCategory('All')" class="w-full text-left p-3 rounded-xl bg-slate-700 hover:bg-slate-600 font-bold text-sm text-white">ğŸŒ Open All</button>
            <button onclick="changeCategory('Nature')" class="w-full text-left p-3 rounded-xl hover:bg-slate-700 text-blue-400 text-sm italic">ğŸŒ¿ Nature</button>
            <button onclick="changeCategory('Health')" class="w-full text-left p-3 rounded-xl hover:bg-slate-700 text-emerald-400 text-sm italic">ğŸ’ª Health</button>
            <button onclick="changeCategory('Food')" class="w-full text-left p-3 rounded-xl hover:bg-slate-700 text-orange-400 text-sm italic">ğŸ Food</button>
            <button onclick="changeCategory('Animals')" class="w-full text-left p-3 rounded-xl hover:bg-slate-700 text-red-400 text-sm italic">ğŸ¦ Animals</button>
            <button onclick="changeCategory('School')" class="w-full text-left p-3 rounded-xl hover:bg-slate-700 text-purple-400 text-sm italic">ğŸ“š School</button>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content flex-grow p-6 lg:p-12 flex flex-col items-center justify-center">
        <div id="flashcard" class="flashcard w-full max-w-xl p-8 lg:p-12 text-center relative overflow-hidden text-slate-900">
            <button onclick="toggleStar()" id="star-btn" class="absolute top-6 right-6 text-slate-200 star-btn">â­</button>
            
            <div id="pinyin" class="text-slate-400 text-xl font-medium mb-2 tracking-widest uppercase">Loading</div>
            <div id="char" class="chinese-char font-black text-blue-600 mb-4" onclick="speakText(currentWord.char, 'hk')"></div>
            <div id="radical" class="inline-block px-3 py-1 bg-slate-100 rounded-full text-[10px] font-black text-slate-400 mb-6 uppercase tracking-wider"></div>
            <div id="meaning" class="text-3xl font-black uppercase text-slate-800 mb-8 tracking-tighter italic"></div>
            
            <div class="border-t border-slate-100 pt-8 text-left">
                <div class="flex items-start gap-3 mb-2">
                    <p id="example" class="text-xl font-bold text-slate-700 leading-tight"></p>
                    <button onclick="speakText(currentWord.example, 'hk')" class="mt-1 bg-blue-100 text-blue-600 w-6 h-6 rounded-full flex items-center justify-center text-[10px]">ğŸ”Š</button>
                </div>
                <div style="display:flex; align-items:start; gap:8px">
                    <p id="example-trans" class="text-sm italic text-slate-400"></p>
                    <button onclick="speakText(currentWord.exampleTrans, 'en')" class="mt-1 bg-slate-50 text-slate-400 w-5 h-5 rounded-full flex items-center justify-center text-[8px]">ğŸ”Š</button>
                </div>
            </div>
        </div>

        <div class="w-full max-w-xl mt-8 grid grid-cols-2 gap-4">
            <button onclick="speakText(currentWord.char, 'hk')" class="audio-btn-main py-4 bg-orange-500 hover:bg-orange-400 rounded-2xl font-black text-white uppercase text-sm">ğŸ“¢ Cantonese</button>
            <button onclick="speakText(currentWord.char, 'cn')" class="audio-btn-main py-4 bg-sky-500 hover:bg-sky-400 rounded-2xl font-black text-white uppercase text-sm">ğŸ“¢ Mandarin</button>
            <button onclick="nextCard()" class="col-span-2 py-5 bg-slate-100 hover:bg-white text-slate-900 rounded-2xl font-black text-xl border-b-4 border-slate-300 active:border-0 active:translate-y-1 transition-all">NEXT WORD &rarr;</button>
        </div>
    </main>

    <!-- AI Sidebar -->
    <aside class="ai-sidebar w-full lg:w-96 p-6 sidebar flex flex-col shrink-0">
        <header class="mb-6"><h3 class="font-bold flex items-center gap-2">ğŸ¤– AI BOT <span class="bg-blue-500/20 text-blue-400 text-[8px] px-1 rounded uppercase font-mono">SECURED</span></h3></header>
        <div id="chat-history" class="flex-grow overflow-y-auto mb-4 space-y-4 pr-2">
            <div class="ai-chat-msg text-slate-400 text-sm italic">Select a word and ask me for details!</div>
        </div>
        <div class="flex gap-2">
            <input type="text" id="user-input" placeholder="Type..." class="flex-grow bg-slate-800 border border-slate-700 p-3 rounded-xl text-sm focus:outline-none focus:border-amber-500">
            <button onclick="sendMessage()" class="bg-amber-500 text-slate-900 font-bold px-4 rounded-xl uppercase text-xs">Ask</button>
        </div>
    </aside>

    <script>
        let allWords = [], sessionWords = [], learnedList = JSON.parse(localStorage.getItem('learned_chars') || '[]');
        let currentIndex = 0, currentWord = null, globalSpeech = window.speechSynthesis, activeBtn = null;

        async function init() {
            try {
                const res = await fetch('vocabulary.json');
                allWords = await res.json();
                changeCategory('All');
                updateProgress();
            } catch (e) { document.getElementById('char').innerText = "ERROR"; }
        }

        function changeCategory(cat) {
            sessionWords = (cat === 'All') ? [...allWords] : allWords.filter(w => w.category === cat);
            currentIndex = Math.floor(Math.random() * sessionWords.length);
            updateCard();
        }

        function updateCard() {
            currentWord = sessionWords[currentIndex];
            document.getElementById('char').innerText = currentWord.char;
            document.getElementById('pinyin').innerText = currentWord.pinyin;
            document.getElementById('radical').innerText = `RADICAL: ${currentWord.radical}`;
            document.getElementById('meaning').innerText = currentWord.meaning;
            document.getElementById('example').innerText = currentWord.example;
            document.getElementById('example-trans').innerText = currentWord.exampleTrans;
            document.getElementById('star-btn').classList.toggle('star-active', learnedList.includes(currentWord.char));
        }

        function toggleStar() {
            const char = currentWord.char;
            learnedList = learnedList.includes(char) ? learnedList.filter(c => c !== char) : [...learnedList, char];
            localStorage.setItem('learned_chars', JSON.stringify(learnedList));
            updateCard(); updateProgress();
        }

        function updateProgress() {
            const count = learnedList.length;
            const pct = Math.round((count / allWords.length) * 100);
            document.getElementById('progress-bar').style.width = pct + '%';
            document.getElementById('progress-text').innerText = `${count} / ${allWords.length} Learned`;
            document.getElementById('progress-percent').innerText = pct + '%';
        }

        function nextCard() { currentIndex = (currentIndex + 1) % sessionWords.length; updateCard(); }

        function speakText(text, lang) {
            globalSpeech.cancel();
            const u = new SpeechSynthesisUtterance(text.replace(/[\u{1F300}-\u{1F9FF}]/gu, ''));
            const vw = globalSpeech.getVoices();
            if (lang === 'hk') {
                u.lang = 'zh-HK';
                u.voice = vw.find(v => v.lang.includes('HK') || v.lang.includes('yue'));
            } else if (lang === 'cn') {
                u.lang = 'zh-CN';
                u.voice = vw.find(v => (v.lang.includes('CN') || v.lang.includes('Hans')) && !v.name.includes('HK'));
            } else { u.lang = 'en-US'; }
            u.rate = 0.8; globalSpeech.speak(u);
        }

        function toggleAudio(btn) {
            const textContent = btn.parentElement.querySelector('.segment-content').innerText;
            if (activeBtn === btn) { globalSpeech.cancel(); btn.innerText = "ğŸ”Š"; activeBtn = null; return; }
            globalSpeech.cancel(); if (activeBtn) activeBtn.innerText = "ğŸ”Š";
            const u = new SpeechSynthesisUtterance(textContent.replace(/[\u{1F300}-\u{1F9FF}]/gu, ''));
            const vw = globalSpeech.getVoices();
            const isChi = /[\u4e00-\u9fa5]/.test(textContent.substring(0, 50));
            u.lang = isChi ? 'zh-HK' : 'en-US';
            u.voice = vw.find(v => v.lang.includes(isChi ? 'HK' : 'US'));
            u.rate = 0.8; u.onend = () => { if (activeBtn === btn) { btn.innerText = "ğŸ”Š"; activeBtn = null; } };
            btn.innerText = "â¹ï¸"; activeBtn = btn; globalSpeech.speak(u);
        }

        async function sendMessage() {
            const inp = document.getElementById('user-input'); if (!inp.value.trim() || !currentWord) return;
            const hist = document.getElementById('chat-history');
            const userTxt = inp.value.trim(); hist.innerHTML += `<div class="ai-chat-msg text-amber-500 border-amber-500/20">Query: ${userTxt}</div>`;
            inp.value = ''; const tid = 't-' + Date.now();
            hist.innerHTML += `<div id="${tid}" class="ai-chat-msg text-slate-400 italic">Processing...</div>`;
            hist.scrollTop = hist.scrollHeight;
            try {
                const r = await fetch('/api/chat', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: userTxt, word: currentWord.char }) });
                const d = await r.json();
                if (d.reply) {
                    const html = d.reply.split('[BREAK]').map(s => `
                        <div class="mb-3 relative pr-8 text-slate-300 border-b border-white/5 pb-2">
                            <span class="segment-content">${s.trim()}</span>
                            <button onclick="toggleAudio(this)" class="speaker-sm absolute top-0 right-0">ğŸ”Š</button>
                        </div>`).join('');
                    document.getElementById(tid).innerHTML = html;
                    document.getElementById(tid).classList.remove('italic');
                }
            } catch (e) { document.getElementById(tid).innerText = "ERROR"; }
            hist.scrollTop = hist.scrollHeight;
        }

        globalSpeech.onvoiceschanged = () => { globalSpeech.getVoices(); };
        init();
    </script>
</body>
</html>
